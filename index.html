<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    
    <!-- PWA / Mobile Meta Tags -->
    <title>Listín Telefónico Hospitalario</title>
    <meta name="description" content="Directorio telefónico rápido para personal hospitalario.">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Listín">
    
    <!-- Icons & Manifest -->
    <link rel="icon" type="image/svg+xml" href="icon.svg" />
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      /* Hide scrollbar for Chrome, Safari and Opera */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      /* Hide scrollbar for IE, Edge and Firefox */
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
    "lucide-react": "https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0",
  }
}
</script>
</head>
<body class="bg-gray-100 text-gray-900 antialiased select-none">
    <div id="root"></div>

    <!-- MAIN APP LOGIC -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Search, Mic, X, MicOff, Phone, Star, PhoneForwarded, MapPin, 
        Pencil, Trash2, Copy, Check, Share2, BookUser, Plus, Save, 
        ArrowLeft, AlertTriangle, Info, Database, Activity, Pill, Siren, 
        Monitor, Baby, Wrench, Settings, Tag as TagIcon 
      } from 'lucide-react';

      // --- UTILS ---
      const normalizeText = (text) => {
        if (!text) return "";
        return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[\.\s-]/g, "");
      };

      const generateId = () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
      };

      const searchContacts = (contacts, query) => {
        if (!query) return contacts;
        const normalizedQuery = normalizeText(query);
        return contacts.filter(c => 
          normalizeText(c.servicio).includes(normalizedQuery) ||
          normalizeText(c.interno).includes(normalizedQuery) ||
          normalizeText(c.externo).includes(normalizedQuery) ||
          normalizeText(c.centro).includes(normalizedQuery) ||
          normalizeText(c.edificio).includes(normalizedQuery)
        );
      };

      const parseCSV = (csvContent) => {
        const content = csvContent.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        const lines = content.split("\n");
        const result = [];
        let separator = ",";
        if (lines.length > 0) {
          const firstLine = lines.find(l => l.trim().length > 0) || "";
          if ((firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length) separator = ";";
        }

        const clean = (str) => {
          if (!str) return "";
          let s = str.trim();
          if (s.startsWith('"') && s.endsWith('"')) s = s.substring(1, s.length - 1);
          return s.replace(/""/g, '"');
        };

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          let columns = [];
          if (!line.includes('"')) {
             columns = line.split(separator);
          } else {
             let currentVal = '';
             let inQuote = false;
             for(let charIdx = 0; charIdx < line.length; charIdx++) {
                 const char = line[charIdx];
                 if (char === '"') inQuote = !inQuote;
                 else if (char === separator && !inQuote) {
                     columns.push(currentVal);
                     currentVal = '';
                     continue;
                 }
                 currentVal += char;
             }
             columns.push(currentVal);
          }

          if (i === 0 && (clean(columns[0] || "").toLowerCase().includes('centro'))) continue;

          if (columns.length >= 1) { 
            result.push({
              id: generateId(),
              centro: clean(columns[0]) || "GENERAL",
              edificio: clean(columns[1]) || "",
              planta: clean(columns[2]) || "",
              servicio: clean(columns[3]) || "Sin Nombre",
              interno: clean(columns[4]) || "",
              externo: clean(columns[5]) || ""
            });
          }
        }
        return result;
      };

      // --- COMPONENTS ---

      // 1. SearchBar
      const SearchBar = ({ value, onChange }) => {
        const [isListening, setIsListening] = useState(false);
        const [recognition, setRecognition] = useState(null);
        const inputRef = useRef(null);

        useEffect(() => {
          if ('webkitSpeechRecognition' in window) {
            const recog = new window.webkitSpeechRecognition();
            recog.continuous = false;
            recog.lang = 'es-ES';
            recog.interimResults = false;
            recog.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              onChange(transcript);
              setIsListening(false);
            };
            recog.onerror = () => setIsListening(false);
            recog.onend = () => setIsListening(false);
            setRecognition(recog);
          }
        }, [onChange]);

        const toggleListening = () => {
          if (!recognition) { alert("Tu navegador no soporta búsqueda por voz."); return; }
          if (isListening) { recognition.stop(); setIsListening(false); }
          else { recognition.start(); setIsListening(true); }
        };

        const handleClear = () => { onChange(''); setIsListening(false); inputRef.current?.focus(); };

        return (
          <div className="sticky top-0 z-50 px-4 pt-4 pb-2 bg-gray-50/90 backdrop-blur-md transition-all duration-300">
            <div className="relative flex items-center w-full shadow-lg rounded-2xl bg-white overflow-hidden border border-gray-100 ring-1 ring-gray-100/50">
              <div className="pl-4 text-blue-500"><Search size={22} strokeWidth={2.5} /></div>
              <input ref={inputRef} type="text" className="w-full py-4 px-3 text-gray-700 font-medium text-lg leading-tight focus:outline-none placeholder-gray-400 bg-transparent" placeholder="Buscar servicio o nº..." value={value} onChange={(e) => onChange(e.target.value)} />
              {value && <button onClick={handleClear} className="p-2 mr-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100"><X size={20} /></button>}
              <button onClick={toggleListening} className={`p-3 m-1 rounded-xl transition-all duration-300 ${isListening ? 'bg-red-500 text-white shadow-md animate-pulse' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`}>
                {isListening ? <MicOff size={22} /> : <Mic size={22} />}
              </button>
            </div>
          </div>
        );
      };

      // 2. ContactCard
      const ContactCard = ({ contact, isFavorite, onToggleFavorite, onEdit, onDelete }) => {
        const [isDeleting, setIsDeleting] = useState(false);
        const [copiedField, setCopiedField] = useState(null);
        const hasExternal = contact.externo && contact.externo.trim() !== '';
        const hasInternal = contact.interno && contact.interno.trim() !== '' && contact.interno.trim() !== 'X';
        const isMaterno = contact.centro.toUpperCase().includes('MATERNO');

        useEffect(() => {
          if (isDeleting) { const t = setTimeout(() => setIsDeleting(false), 3000); return () => clearTimeout(t); }
        }, [isDeleting]);

        useEffect(() => {
          if (copiedField) { const t = setTimeout(() => setCopiedField(null), 2000); return () => clearTimeout(t); }
        }, [copiedField]);

        const handleCopy = (e, text, field) => {
          e.preventDefault(); e.stopPropagation();
          navigator.clipboard.writeText(text);
          setCopiedField(field);
          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        };

        const handleShare = async (e) => {
          e.stopPropagation();
          if (navigator.share) {
            try { await navigator.share({ title: contact.servicio, text: `Contacto Hospital: ${contact.servicio}\nInterno: ${contact.interno}\nExterno: ${contact.externo}` }); } catch (err) {}
          } else {
             navigator.clipboard.writeText(`${contact.servicio} (Int: ${contact.interno})`);
             alert('Copiado');
          }
        };

        return (
          <div className={`bg-white rounded-2xl shadow-sm border-l-4 p-4 mb-3 relative animate-fadeIn active:scale-[0.99] transition-transform ${isMaterno ? 'border-l-pink-500' : 'border-l-teal-500'}`}>
            <div className="flex justify-between items-start mb-2">
              <div className="pr-4"> 
                <div className="flex flex-wrap gap-2 mb-1">
                  <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider ${isMaterno ? 'bg-pink-50 text-pink-600' : 'bg-teal-50 text-teal-600'}`}>{contact.centro}</span>
                  {contact.edificio && <span className="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-gray-100 text-gray-500 flex items-center"><MapPin size={8} className="mr-1" />{contact.edificio} {contact.planta ? `• P${contact.planta}` : ''}</span>}
                </div>
                <h3 className="font-bold text-gray-800 text-lg leading-snug pr-12">{contact.servicio}</h3>
              </div>
              <div className="absolute top-2 right-2 flex items-center gap-1 z-10 bg-white/95 backdrop-blur-sm rounded-lg p-0.5 shadow-sm border border-gray-100">
                 {!isDeleting && <button onClick={handleShare} className="p-1.5 text-gray-400 hover:text-blue-500 rounded-full"><Share2 size={16} /></button>}
                 {!isDeleting && <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(contact.id); }} className={`p-1.5 rounded-full ${isFavorite ? 'text-yellow-400' : 'text-gray-300'}`}><Star size={18} fill={isFavorite ? "currentColor" : "none"} /></button>}
                 {!isDeleting && <button onClick={(e) => { e.stopPropagation(); onEdit(contact); }} className="p-1.5 text-gray-300 hover:text-blue-500"><Pencil size={16} /></button>}
                 <button onClick={(e) => { e.stopPropagation(); if(isDeleting) onDelete(contact.id); else setIsDeleting(true); }} className={`p-1.5 rounded-full flex items-center justify-center ${isDeleting ? 'bg-red-500 text-white w-auto px-2' : 'text-gray-300'}`}>{isDeleting ? <Trash2 size={14} /> : <Trash2 size={16} />}</button>
              </div>
            </div>
            <div className="flex gap-3 mt-4">
              {hasInternal && (
                <div className="flex-1 relative group">
                  <a href={`tel:${contact.interno}`} className="flex flex-col items-center justify-center bg-blue-50 text-blue-700 py-3 rounded-xl hover:bg-blue-100 transition-colors w-full h-full">
                    <Phone size={20} className="mb-1" /><span className="text-sm font-bold tracking-tight">Ext. {contact.interno}</span>
                  </a>
                  <button onClick={(e) => handleCopy(e, contact.interno, 'internal')} className="absolute top-1 right-1 p-1.5 rounded-full text-blue-300 hover:text-blue-600 hover:bg-blue-200/50">{copiedField === 'internal' ? <Check size={14} /> : <Copy size={14} />}</button>
                </div>
              )}
              {hasExternal ? (
                <div className="flex-1 relative group">
                  <a href={`tel:${contact.externo}`} className="flex flex-col items-center justify-center bg-green-50 text-green-700 py-3 rounded-xl hover:bg-green-100 transition-colors w-full h-full">
                    <PhoneForwarded size={20} className="mb-1" /><span className="text-sm font-bold tracking-tight">{contact.externo}</span>
                  </a>
                  <button onClick={(e) => handleCopy(e, contact.externo, 'external')} className="absolute top-1 right-1 p-1.5 rounded-full text-green-300 hover:text-green-600 hover:bg-green-200/50">{copiedField === 'external' ? <Check size={14} /> : <Copy size={14} />}</button>
                </div>
              ) : (
                <div className="flex-1 flex flex-col items-center justify-center bg-gray-50 text-gray-300 py-3 rounded-xl border border-dashed border-gray-200"><PhoneForwarded size={20} className="mb-1 opacity-50" /><span className="text-xs font-medium">Sin externo</span></div>
              )}
            </div>
          </div>
        );
      };

      // 3. BottomNav
      const BottomNav = ({ currentView, onChangeView }) => {
        const navItemClass = (view) => `flex flex-col items-center justify-center w-full h-full transition-all duration-200 ${currentView === view ? 'text-blue-600 scale-105' : 'text-gray-400'}`;
        return (
          <div className="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-lg border-t border-gray-200 pb-safe pt-2 px-6 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] z-40">
            <div className="flex justify-between items-center h-16 max-w-md mx-auto relative">
              <button onClick={() => onChangeView('HOME')} className={navItemClass('HOME')}><BookUser size={26} strokeWidth={currentView === 'HOME' ? 2.5 : 2} /><span className="text-[10px] font-semibold mt-1">Directorio</span></button>
              <div className="relative -top-6">
                <button onClick={() => onChangeView('ADD')} className={`flex items-center justify-center w-14 h-14 rounded-full shadow-xl shadow-blue-500/30 transition-transform active:scale-90 ${currentView === 'ADD' ? 'bg-gray-800 text-white' : 'bg-gradient-to-tr from-blue-600 to-indigo-600 text-white'}`}><Plus size={32} strokeWidth={3} /></button>
              </div>
              <button onClick={() => onChangeView('FAVORITES')} className={navItemClass('FAVORITES')}><Star size={26} strokeWidth={currentView === 'FAVORITES' ? 2.5 : 2} /><span className="text-[10px] font-semibold mt-1">Favoritos</span></button>
            </div>
          </div>
        );
      };

      // 4. AddContactForm
      const AddContactForm = ({ initialData, onSave, onCancel }) => {
        const [formData, setFormData] = useState(initialData || { id: '', centro: 'MATERNO', edificio: '', planta: '', servicio: '', interno: '', externo: '' });
        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
        const handleSubmit = (e) => { e.preventDefault(); if (!formData.servicio) return alert('Nombre obligatorio'); onSave({ ...formData, id: formData.id || generateId() }); };
        
        return (
          <div className="min-h-screen bg-gray-50 pb-20">
            <div className="bg-blue-600 p-4 text-white flex items-center shadow-md sticky top-0 z-10">
              <button type="button" onClick={onCancel} className="mr-3"><ArrowLeft /></button>
              <h2 className="text-lg font-bold">{initialData ? 'Editar Contacto' : 'Añadir Contacto'}</h2>
            </div>
            <div className="p-4 max-w-lg mx-auto space-y-6">
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Centro</label><select name="centro" value={formData.centro} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg"><option value="MATERNO">MATERNO</option><option value="INSULAR">INSULAR</option><option value="ANEXO">ANEXO</option><option value="OTRO">OTRO</option></select></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Servicio *</label><input type="text" name="servicio" value={formData.servicio} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" required /></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Zona</label><input type="text" name="edificio" value={formData.edificio} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Planta</label><input type="text" name="planta" value={formData.planta} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Interno</label><input type="tel" name="interno" value={formData.interno} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">Público</label><input type="tel" name="externo" value={formData.externo} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg" /></div>
                  </div>
                </div>
                <button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center"><Save className="mr-2" />Guardar</button>
              </form>
            </div>
          </div>
        );
      };

      // --- APP COMPONENT ---
      const DEFAULT_TAGS = [
        { id: '1', label: 'Urgencias', iconName: 'Siren', color: 'bg-red-100 text-red-600', term: 'Urgencias' },
        { id: '2', label: 'Farmacia', iconName: 'Pill', color: 'bg-green-100 text-green-600', term: 'Farmacia' },
        { id: '3', label: 'Informática', iconName: 'Monitor', color: 'bg-blue-100 text-blue-600', term: 'Informatica' },
        { id: '4', label: 'Paritorios', iconName: 'Baby', color: 'bg-pink-100 text-pink-600', term: 'Paritorio' },
        { id: '5', label: 'Laboratorio', iconName: 'Activity', color: 'bg-purple-100 text-purple-600', term: 'Laboratorio' },
        { id: '6', label: 'Mantenimiento', iconName: 'Wrench', color: 'bg-orange-100 text-orange-600', term: 'Mantenimiento' },
      ];

      const App = () => {
        const [contacts, setContacts] = useState([]);
        const [searchQuery, setSearchQuery] = useState('');
        const [favorites, setFavorites] = useState([]);
        const [currentView, setCurrentView] = useState('HOME');
        const [visibleLimit, setVisibleLimit] = useState(50);
        const [showDirectory, setShowDirectory] = useState(false);
        const [editingContact, setEditingContact] = useState(null);
        const [quickTags, setQuickTags] = useState(DEFAULT_TAGS);
        const [isManagingTags, setIsManagingTags] = useState(false);
        const [selectedTagsToDelete, setSelectedTagsToDelete] = useState([]);
        const [showAddTagModal, setShowAddTagModal] = useState(false);
        const [newTagLabel, setNewTagLabel] = useState('');
        const [newTagTerm, setNewTagTerm] = useState('');

        useEffect(() => {
          const loadData = async () => {
            // Load Contacts
            const stored = localStorage.getItem('app_contacts');
            if (stored) setContacts(JSON.parse(stored));
            else {
              try {
                const res = await fetch('assets/MATERNO-2025.csv');
                if (res.ok) {
                   const text = await res.text();
                   setContacts(parseCSV(text));
                }
              } catch (e) { console.error(e); }
            }
            // Load Favorites & Tags
            const favs = localStorage.getItem('favorites');
            if (favs) setFavorites(JSON.parse(favs));
            const tags = localStorage.getItem('app_quick_tags');
            if (tags) setQuickTags(JSON.parse(tags));
          };
          loadData();
        }, []);

        useEffect(() => { localStorage.setItem('app_contacts', JSON.stringify(contacts)); }, [contacts]);
        useEffect(() => { localStorage.setItem('favorites', JSON.stringify(favorites)); }, [favorites]);
        useEffect(() => { localStorage.setItem('app_quick_tags', JSON.stringify(quickTags)); }, [quickTags]);

        const filteredContacts = useMemo(() => {
          let result = contacts;
          if (currentView === 'FAVORITES') result = result.filter(c => favorites.includes(c.id));
          return searchContacts(result, searchQuery);
        }, [contacts, searchQuery, currentView, favorites]);

        const handleViewChange = (view) => {
          if (view === 'HOME') {
            if (currentView === 'HOME') setShowDirectory(!showDirectory);
            else setShowDirectory(true);
            setSearchQuery('');
          } else {
            setShowDirectory(false);
          }
          setCurrentView(view);
        };

        const renderIcon = (name) => {
          switch (name) {
            case 'Siren': return <Siren size={18} />;
            case 'Pill': return <Pill size={18} />;
            case 'Monitor': return <Monitor size={18} />;
            case 'Baby': return <Baby size={18} />;
            case 'Activity': return <Activity size={18} />;
            case 'Wrench': return <Wrench size={18} />;
            default: return <TagIcon size={18} />;
          }
        };

        if (currentView === 'ADD' || currentView === 'EDIT') {
          return <AddContactForm initialData={editingContact} onSave={(c) => {
             if (currentView === 'EDIT') setContacts(contacts.map(old => old.id === c.id ? c : old));
             else setContacts([c, ...contacts]);
             setEditingContact(null); setCurrentView('HOME'); setSearchQuery(c.servicio);
          }} onCancel={() => { setEditingContact(null); setCurrentView('HOME'); }} />;
        }

        const shouldShowList = currentView === 'FAVORITES' || searchQuery.length > 0 || showDirectory;

        return (
          <div className="flex flex-col h-screen bg-gray-50 font-sans">
            <div className="flex-1 flex flex-col z-10 overflow-hidden">
              <SearchBar value={searchQuery} onChange={setSearchQuery} />
              
              <main className="flex-1 overflow-y-auto pb-24 px-4 pt-2 scroll-smooth no-scrollbar relative">
                <div className="absolute top-0 left-0 w-full h-[100px] bg-gradient-to-br from-blue-600 to-indigo-800 rounded-b-[20px] shadow-lg -z-10"></div>
                
                {!shouldShowList && currentView === 'HOME' && (
                  <div className="animate-fadeIn">
                    <div className="bg-white/10 backdrop-blur-sm border border-white/20 py-2 px-3 rounded-2xl text-white shadow-lg relative overflow-hidden mb-6">
                      <div className="relative z-10 flex flex-col items-center text-center">
                        <h1 className="text-xl font-bold mb-0.5">Listín Telefónico</h1>
                        <p className="text-blue-100 text-xs mb-1.5">Hospital Materno & Insular</p>
                        <span className="bg-white/20 px-3 py-1 rounded-full text-xs font-medium flex items-center backdrop-blur-md border border-white/10"><Database size={12} className="mr-1.5 opacity-80" />{contacts.length} contactos</span>
                      </div>
                    </div>

                    <div className="flex justify-between items-center mb-3 px-2">
                       <h2 className="text-gray-800 font-bold text-lg">{isManagingTags ? 'Borrar Accesos' : 'Accesos Rápidos'}</h2>
                       <button onClick={() => { setIsManagingTags(!isManagingTags); setSelectedTagsToDelete([]); }} className={`px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 ${isManagingTags ? 'bg-blue-600 text-white' : 'bg-white text-gray-500 border border-gray-200'}`}>
                         {isManagingTags ? <><Check size={14}/> HECHO</> : <><Settings size={14}/> EDITAR</>}
                       </button>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mb-6 transition-all">
                      {quickTags.map((tag) => {
                        const isSel = selectedTagsToDelete.includes(tag.id);
                        return (
                          <button key={tag.id} onClick={() => {
                             if(isManagingTags) setSelectedTagsToDelete(prev => prev.includes(tag.id) ? prev.filter(id=>id!==tag.id) : [...prev, tag.id]);
                             else { setSearchQuery(tag.term); setShowDirectory(false); }
                          }} className={`w-full p-4 rounded-2xl shadow-sm border flex items-center space-x-3 text-left relative overflow-hidden ${isManagingTags ? (isSel ? 'bg-red-50 border-red-500 ring-2 ring-red-500' : 'opacity-70') : 'bg-white border-gray-100'}`}>
                            {isManagingTags && isSel && <div className="absolute top-2 right-2 text-red-500"><Check size={16} strokeWidth={4}/></div>}
                            <div className={`p-3 rounded-full ${isManagingTags && isSel ? 'bg-red-100 text-red-600' : tag.color}`}>{renderIcon(tag.iconName)}</div>
                            <span className="font-semibold text-sm truncate">{tag.label}</span>
                          </button>
                        );
                      })}
                      {!isManagingTags && quickTags.length < 8 && (
                        <button onClick={() => setShowAddTagModal(true)} className="bg-gray-100 p-4 rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 hover:bg-white hover:border-blue-400 hover:text-blue-500"><Plus size={24} /><span className="text-xs font-bold mt-1">Añadir</span></button>
                      )}
                    </div>
                    {isManagingTags && selectedTagsToDelete.length > 0 && (
                      <div className="fixed bottom-24 left-0 w-full px-6 z-30"><button onClick={() => { setQuickTags(prev => prev.filter(t => !selectedTagsToDelete.includes(t.id))); setIsManagingTags(false); }} className="w-full py-4 rounded-xl font-bold bg-red-600 text-white shadow-xl flex items-center justify-center gap-2"><Trash2 size={20}/> ELIMINAR SELECCIONADOS</button></div>
                    )}
                  </div>
                )}

                {shouldShowList && (
                   <div className="space-y-1 mt-2">
                     {filteredContacts.slice(0, visibleLimit).map(contact => (
                       <ContactCard key={contact.id} contact={contact} isFavorite={favorites.includes(contact.id)} onToggleFavorite={(id) => setFavorites(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev, id])} onEdit={(c) => { setEditingContact(c); setCurrentView('EDIT'); }} onDelete={(id) => { setContacts(prev => prev.filter(c => c.id !== id)); setFavorites(prev => prev.filter(f => f !== id)); }} />
                     ))}
                     {filteredContacts.length > visibleLimit && <button onClick={() => setVisibleLimit(prev => prev + 50)} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-medium text-sm mt-4">Cargar más...</button>}
                     {filteredContacts.length === 0 && <div className="text-center py-20 text-gray-400"><Info size={48} className="mx-auto mb-4 opacity-20" /><p>Sin resultados</p></div>}
                   </div>
                )}
              </main>
            </div>
            
            {showAddTagModal && (
               <div className="fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/40 backdrop-blur-sm" onClick={() => setShowAddTagModal(false)}>
                 <div className="bg-white rounded-2xl p-6 w-full max-w-sm" onClick={e => e.stopPropagation()}>
                    <h3 className="font-bold text-lg mb-4">Nuevo Botón</h3>
                    <input type="text" placeholder="Nombre (ej. Rayos)" value={newTagLabel} onChange={e => setNewTagLabel(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl border mb-4" />
                    <input type="text" placeholder="Búsqueda (ej. Radiología)" value={newTagTerm} onChange={e => setNewTagTerm(e.target.value)} className="w-full p-3 bg-gray-50 rounded-xl border mb-6" />
                    <div className="flex gap-3">
                      <button onClick={() => setShowAddTagModal(false)} className="flex-1 py-3 text-gray-500">Cancelar</button>
                      <button onClick={() => { setQuickTags([...quickTags, { id: Date.now().toString(), label: newTagLabel, term: newTagTerm, color: 'bg-gray-100 text-gray-600', iconName: 'Tag' }]); setShowAddTagModal(false); setNewTagLabel(''); setNewTagTerm(''); }} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold">Añadir</button>
                    </div>
                 </div>
               </div>
            )}
            
            <BottomNav currentView={currentView} onChangeView={handleViewChange} />
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Prevent error in non-http environments (like local file system or some previews)
          if (window.location.protocol.startsWith('http')) {
             navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW ok', reg.scope))
                .catch(err => console.log('SW failed', err));
          }
        });
      }
    </script>
</body>
</html>